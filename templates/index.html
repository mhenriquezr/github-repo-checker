<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Repository Checker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 0.95em;
            opacity: 0.8;
        }
        
        .card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 20px;
            border: 1px solid #3a3a3a;
        }
        
        .card h3 {
            color: #e0e0e0;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #3a3a3a;
        }
        
        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1em;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }
        
        .tab:hover {
            color: #b0b0b0;
        }
        
        .tab.active {
            color: #e0e0e0;
            border-bottom-color: #e0e0e0;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .repo-checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin-bottom: 4px;
            background: #2a2a2a;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .repo-checkbox-label:hover {
            background: #353535;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #b0b0b0;
            font-size: 0.9em;
        }
        
        select {
            cursor: pointer;
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #4a4a4a;
            border-radius: 6px;
            font-size: 0.95em;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #4a4a4a;
            border-radius: 6px;
            font-size: 0.95em;
            transition: border-color 0.3s;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #5a5a5a;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background: #3a3a3a;
            color: white;
            border: 1px solid #4a4a4a;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #4a4a4a;
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            display: none;
        }
        
        .spinner {
            border: 4px solid #3a3a3a;
            border-top: 4px solid #e0e0e0;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .result {
            display: none;
        }
        
        .result-header {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            margin-top: 20px;
        }
        
        .result-header.passed {
            background: #1e4d2b;
            color: white;
            border: 1px solid #2d6a3e;
        }
        
        .result-header.failed {
            background: #4d1e1e;
            color: white;
            border: 1px solid #6a2d2d;
        }
        
        .result-header h2 {
            margin-bottom: 8px;
            font-size: 1.3em;
        }
        
        .score {
            font-size: 2.5em;
            font-weight: bold;
            margin: 8px 0;
        }
        
        .repo-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }
        
        .repo-info-item {
            display: flex;
            flex-direction: column;
        }
        
        .repo-info-item label {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 4px;
        }
        
        .repo-info-item span {
            font-weight: 600;
            color: #e0e0e0;
        }
        
        .checks {
            margin-top: 20px;
        }
        
        .check-item {
            padding: 10px 12px;
            margin-bottom: 6px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .check-item.passed {
            background: #1e2e1e;
            border-left: 4px solid #4caf50;
        }
        
        .check-item.failed {
            background: #2e1e1e;
            border-left: 4px solid #f44336;
        }
        
        .check-item.warning {
            background: #2e2a1e;
            border-left: 4px solid #ff9800;
        }
        
        .check-icon {
            font-size: 1.2em;
        }
        
        .check-name {
            font-weight: 600;
            flex: 0 0 140px;
            font-size: 0.9em;
        }
        
        .check-message {
            flex: 1;
            color: #b0b0b0;
            font-size: 0.85em;
        }
        
        .error {
            background: #2e1e1e;
            color: #ff6b6b;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #f44336;
            display: none;
            margin-top: 20px;
        }
        
        .criteria {
            margin-top: 20px;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }
        
        .criteria h3 {
            margin-bottom: 15px;
            color: #e0e0e0;
        }
        
        .criteria ul {
            list-style: none;
            padding-left: 0;
        }
        
        .criteria li {
            padding: 8px 0;
            border-bottom: 1px solid #3a3a3a;
            color: #b0b0b0;
        }
        
        .criteria li:last-child {
            border-bottom: none;
        }
        
        .criteria p {
            color: #b0b0b0;
        }
        
        .criteria strong {
            color: #e0e0e0;
        }
        
        .batch-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 4px solid;
        }
        
        .batch-item.passed {
            background: #1e2e1e;
            border-left-color: #4caf50;
        }
        
        .batch-item.failed {
            background: #2e1e1e;
            border-left-color: #f44336;
        }
        
        .batch-item.error {
            background: #2e2a1e;
            border-left-color: #ff9800;
        }
        
        .batch-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }
        
        .batch-name {
            flex: 1;
            font-weight: 600;
            color: #e0e0e0;
            font-size: 0.95em;
        }
        
        .batch-stats {
            display: flex;
            gap: 12px;
            font-size: 0.85em;
            color: #b0b0b0;
            align-items: center;
        }
        
        .batch-score {
            font-weight: bold;
            font-size: 1.2em;
        }
        
        .batch-details {
            font-size: 0.8em;
            color: #a0a0a0;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid #3a3a3a;
        }
        
        .batch-details ul {
            margin: 4px 0;
            padding-left: 18px;
        }
        
        .batch-details li {
            margin: 2px 0;
        }
        
        .batch-details strong {
            font-size: 0.9em;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #1a1a1a;
            border-radius: 15px;
            overflow: visible;
            margin: 15px 0;
            border: 1px solid #3a3a3a;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: #4a4a4a;
            transition: width 0.3s ease;
            border-radius: 15px;
        }
        
        .progress-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>GitHub Repository Checker</h1>
        </div>
        
        
        <div class="card">
            <div class="tabs">
                <button class="tab active" data-tab="verify">Verify</button>
                <button class="tab" data-tab="search">Search</button>
                <button class="tab" data-tab="batch">Test Approved Repos</button>
                <button class="tab" data-tab="settings">Settings</button>
            </div>
            
            <div id="verifyTab" class="tab-content active">
                <form id="verifyForm">
                    <div class="input-group">
                        <label for="repoUrl">Repository URL</label>
                        <input 
                            type="text" 
                            id="repoUrl" 
                            placeholder="https://github.com/owner/repo"
                            required
                        >
                    </div>
                    <button type="submit" class="btn" id="verifyBtn">Verify Repository</button>
                </form>
                
                <div class="loading" id="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Checking repository...</p>
                </div>
                
                <div class="error" id="error" style="display: none;"></div>
                
                <div class="result" id="result" style="display: none;">
                    <div class="result-header" id="resultHeader">
                        <h2 id="repoName"></h2>
                        <div class="score" id="score"></div>
                        <p id="summary"></p>
                    </div>
                    
                    <div class="repo-info" id="repoInfo"></div>
                    
                    <div class="checks" id="checks"></div>
                </div>
            </div>
            
            <div id="searchTab" class="tab-content">
                <form id="searchForm">
                    <div class="input-group">
                        <label for="searchQuery">Keywords / Library</label>
                        <input 
                            type="text" 
                            id="searchQuery" 
                            placeholder="e.g., pygame, flask"
                        >
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div class="input-group">
                            <label for="searchLanguage">Language</label>
                            <select id="searchLanguage">
                                <option value="">Any</option>
                                <option value="Python">Python</option>
                                <option value="JavaScript">JavaScript</option>
                                <option value="TypeScript">TypeScript</option>
                                <option value="Rust">Rust</option>
                                <option value="Go">Go</option>
                                <option value="Java">Java</option>
                                <option value="C++">C++</option>
                                <option value="C#">C#</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label for="searchRepoAge">Repository Age</label>
                            <select id="searchRepoAge">
                                <option value="">Any age</option>
                                <option value="6">Less than 6 months</option>
                                <option value="12">Less than 1 year</option>
                                <option value="24">Less than 2 years</option>
                                <option value="36">Less than 3 years</option>
                                <option value="60">Less than 5 years</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label for="searchMaxResults">Max Results</label>
                            <select id="searchMaxResults">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="15">15</option>
                                <option value="20">20</option>
                            </select>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn" id="searchBtn">Search & Verify</button>
                </form>
                
                <div class="loading" id="searchLoading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Searching repositories...</p>
                </div>
                
                <div class="error" id="searchError" style="display: none;"></div>
                
                <div id="searchResults" style="display: none; margin-top: 15px;">
                    <h4 style="margin-bottom: 12px; color: #e0e0e0;">Results</h4>
                    <div id="searchResultsList"></div>
                </div>
            </div>
            
            <div id="batchTab" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0; color: #e0e0e0;">Approved Repositories</h4>
                    <div style="display: flex; gap: 10px;">
                        <button 
                            type="button" 
                            class="btn" 
                            id="selectAllBtn"
                            style="width: auto; padding: 8px 15px; font-size: 0.85em;"
                        >
                            Select All
                        </button>
                        <button 
                            type="button" 
                            class="btn" 
                            id="testSelectedBtn"
                            style="width: auto; padding: 8px 15px; font-size: 0.85em;"
                        >
                            Test Selected
                        </button>
                    </div>
                </div>
                
                <div id="repoList" style="max-height: 400px; overflow-y: auto; margin-bottom: 15px; padding: 10px; background: #1a1a1a; border-radius: 6px; border: 1px solid #3a3a3a;">
                    <p style="text-align: center; color: #888;">Loading repositories...</p>
                </div>
                
                <div class="result" id="batchResult" style="display: none;">
                    <div style="background: #1a1a1a; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #3a3a3a;">
                        <h4 style="margin-bottom: 10px; color: #e0e0e0;">Results Summary</h4>
                        <div id="batchSummary" style="font-size: 0.95em;"></div>
                    </div>
                    <div id="batchResults"></div>
                </div>
            </div>
            
            <div id="settingsTab" class="tab-content">
                <h4 style="margin-bottom: 15px; color: #e0e0e0;">Repository Approval Criteria</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="input-group">
                        <label for="settingMinStars">Min Stars</label>
                        <input 
                            type="number" 
                            id="settingMinStars" 
                            value="200"
                            min="0"
                        >
                    </div>
                    
                    <div class="input-group">
                        <label for="settingMinContributors">Min Contributors</label>
                        <input 
                            type="number" 
                            id="settingMinContributors" 
                            value="3"
                            min="1"
                        >
                    </div>
                    
                    <div class="input-group">
                        <label for="settingMinFiles">Min Files</label>
                        <input 
                            type="number" 
                            id="settingMinFiles" 
                            value="30"
                            min="1"
                        >
                    </div>
                    
                    <div class="input-group">
                        <label for="settingMinDirectories">Min Directories</label>
                        <input 
                            type="number" 
                            id="settingMinDirectories" 
                            value="8"
                            min="1"
                        >
                    </div>
                    
                    <div class="input-group">
                        <label for="settingMaxSizeMB">Max Size (MB)</label>
                        <input 
                            type="number" 
                            id="settingMaxSizeMB" 
                            value="500"
                            min="1"
                        >
                    </div>
                    
                    <div class="input-group">
                        <label for="settingActivityDays">Activity Days</label>
                        <input 
                            type="number" 
                            id="settingActivityDays" 
                            value="180"
                            min="30"
                        >
                    </div>
                    
                    <div class="input-group">
                        <label for="settingPassThreshold">Pass Threshold (%)</label>
                        <input 
                            type="number" 
                            id="settingPassThreshold" 
                            value="75"
                            min="0"
                            max="100"
                        >
                    </div>
                </div>
                
                <button class="btn" id="saveSettingsBtn" style="margin-top: 10px;">Save Settings</button>
                
                <div style="margin-top: 20px; padding: 15px; background: #1a1a1a; border-radius: 6px; border: 1px solid #3a3a3a;">
                    <h4 style="margin-bottom: 10px; color: #e0e0e0; font-size: 1em;">Evaluation Criteria</h4>
                    <ul style="list-style: none; padding-left: 0; font-size: 0.85em; color: #b0b0b0;">
                        <li style="padding: 4px 0;">✓ Valid git repository</li>
                        <li style="padding: 4px 0;">✓ Detected primary language</li>
                        <li style="padding: 4px 0;">✓ Open source license</li>
                        <li style="padding: 4px 0;">✓ Minimum contributors (configurable above)</li>
                        <li style="padding: 4px 0;">✓ Minimum files & directories (configurable above)</li>
                        <li style="padding: 4px 0;">✓ Not vibe-coded (quality indicators)</li>
                        <li style="padding: 4px 0;">✓ Maximum size (configurable above)</li>
                        <li style="padding: 4px 0;">✓ Testing practices (recommended)</li>
                        <li style="padding: 4px 0;">✓ Recent activity (configurable above)</li>
                        <li style="padding: 4px 0;">✓ Code quality tools</li>
                    </ul>
                </div>
                
                <p style="margin-top: 15px; font-size: 0.85em; color: #888;">
                    These settings define the minimum requirements for a repository to be approved. Changes will apply to all future verifications.
                </p>
            </div>
        </div>
        
    </div>
    
    <script>
        // Tab switching
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(tc => tc.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(targetTab + 'Tab').classList.add('active');
            });
        });
        
        // Settings
        const settingsKey = 'github_checker_settings';
        let settings = {
            minStars: 200,
            minContributors: 3,
            minFiles: 30,
            minDirectories: 8,
            maxSizeMB: 500,
            activityDays: 180,
            passThreshold: 75
        };
        
        // Load settings
        try {
            const saved = localStorage.getItem(settingsKey);
            if (saved) {
                settings = { ...settings, ...JSON.parse(saved) };
            }
        } catch (e) {}
        
        // Apply settings to form
        function loadSettingsToForm() {
            document.getElementById('settingMinStars').value = settings.minStars;
            document.getElementById('settingMinContributors').value = settings.minContributors;
            document.getElementById('settingMinFiles').value = settings.minFiles;
            document.getElementById('settingMinDirectories').value = settings.minDirectories;
            document.getElementById('settingMaxSizeMB').value = settings.maxSizeMB;
            document.getElementById('settingActivityDays').value = settings.activityDays;
            document.getElementById('settingPassThreshold').value = settings.passThreshold;
        }
        
        loadSettingsToForm();
        
        // Save settings
        document.getElementById('saveSettingsBtn').addEventListener('click', () => {
            settings.minStars = parseInt(document.getElementById('settingMinStars').value) || 3;
            settings.minContributors = parseInt(document.getElementById('settingMinContributors').value) || 3;
            settings.minFiles = parseInt(document.getElementById('settingMinFiles').value) || 30;
            settings.minDirectories = parseInt(document.getElementById('settingMinDirectories').value) || 8;
            settings.maxSizeMB = parseInt(document.getElementById('settingMaxSizeMB').value) || 500;
            settings.activityDays = parseInt(document.getElementById('settingActivityDays').value) || 180;
            settings.passThreshold = parseInt(document.getElementById('settingPassThreshold').value) || 75;
            
            localStorage.setItem(settingsKey, JSON.stringify(settings));
            
            // Show success message
            const btn = document.getElementById('saveSettingsBtn');
            const originalText = btn.textContent;
            btn.textContent = 'Saved!';
            btn.style.background = '#1e4d2b';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 1500);
        });
    
        const form = document.getElementById('verifyForm');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const result = document.getElementById('result');
        const batchResult = document.getElementById('batchResult');
        const verifyBtn = document.getElementById('verifyBtn');
        const testSelectedBtn = document.getElementById('testSelectedBtn');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const repoList = document.getElementById('repoList');
        
        let approvedRepos = [];
        
        // Load approved repos when batch tab is opened
        tabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                if (tab.dataset.tab === 'batch' && approvedRepos.length === 0) {
                    await loadApprovedRepos();
                }
            });
        });
        
        async function loadApprovedRepos() {
            try {
                const response = await fetch('/api/approved');
                const data = await response.json();
                approvedRepos = data.repos;
                displayRepoList(approvedRepos);
            } catch (err) {
                repoList.innerHTML = `<p style="text-align: center; color: #f44336;">Failed to load repositories</p>`;
            }
        }
        
        function displayRepoList(repos) {
            let html = '';
            repos.forEach((repo, index) => {
                const repoName = repo.split('/').slice(-2).join('/');
                html += `
                    <label class="repo-checkbox-label">
                        <input type="checkbox" class="repo-checkbox" value="${repo}" checked style="width: auto; cursor: pointer;">
                        <span style="flex: 1; color: #e0e0e0; font-size: 0.9em;">${repoName}</span>
                    </label>
                `;
            });
            repoList.innerHTML = html;
            
            // Add event listener to checkboxes to update select all button
            document.querySelectorAll('.repo-checkbox').forEach(cb => {
                cb.addEventListener('change', updateSelectAllButton);
            });
            
            // Update button text since all start checked
            updateSelectAllButton();
        }
        
        function updateSelectAllButton() {
            const checkboxes = document.querySelectorAll('.repo-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            selectAllBtn.textContent = allChecked ? 'Deselect All' : 'Select All';
        }
        
        // Select/Deselect all
        selectAllBtn.addEventListener('click', () => {
            const checkboxes = document.querySelectorAll('.repo-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            updateSelectAllButton();
        });
        
        // Test selected repos
        testSelectedBtn.addEventListener('click', async () => {
            const selectedRepos = Array.from(document.querySelectorAll('.repo-checkbox:checked'))
                .map(cb => cb.value);
            
            if (selectedRepos.length === 0) {
                alert('Please select at least one repository');
                return;
            }
            
            await testRepositories(selectedRepos);
        });
        
        async function testRepositories(repos) {
            batchResult.style.display = 'none';
            testSelectedBtn.disabled = true;
            selectAllBtn.disabled = true;
            
            try {
                const total = repos.length;
                const results = [];
                
                repoList.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <div class="spinner"></div>
                        <p>Testing ${total} repositories...</p>
                        <p id="currentRepo" style="font-size: 0.9em; color: #888; margin-top: 10px;">Starting...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            <div class="progress-text" id="progressText">0/${total}</div>
                        </div>
                    </div>
                `;
                
                // Show batch result container immediately
                batchResult.style.display = 'block';
                document.getElementById('batchSummary').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 10px;">
                        <div>
                            <div style="font-size: 0.85em; color: #888;">Total</div>
                            <div style="font-size: 1.5em; font-weight: bold;" id="summaryTotal">${total}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85em; color: #888;">Passed</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #4caf50;" id="summaryPassed">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85em; color: #888;">Failed</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #f44336;" id="summaryFailed">0</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85em; color: #888;">Errors</div>
                            <div style="font-size: 1.5em; font-weight: bold; color: #ff9800;" id="summaryErrors">0</div>
                        </div>
                    </div>
                `;
                document.getElementById('batchResults').innerHTML = '';
                
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                const currentRepo = document.getElementById('currentRepo');
                const batchResultsDiv = document.getElementById('batchResults');
                
                // Verify one by one to show progress and immediate results
                let passedCount = 0;
                let failedCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < repos.length; i++) {
                    const repo = repos[i];
                    const repoName = repo.split('/').slice(-2).join('/');
                    
                    currentRepo.textContent = `Checking ${repoName}...`;
                    
                    let itemData;
                    try {
                        const response = await fetch('/api/verify-single', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ 
                                repo_url: repo,
                                settings: settings
                            })
                        });
                        
                        itemData = await response.json();
                        results.push(itemData);
                    } catch (err) {
                        itemData = {
                            url: repo,
                            name: repoName,
                            error: err.message,
                            passed: false,
                            score: 0
                        };
                        results.push(itemData);
                    }
                    
                    // Update counts
                    if (itemData.error) {
                        errorCount++;
                    } else if (itemData.passed) {
                        passedCount++;
                    } else {
                        failedCount++;
                    }
                    
                    // Display result immediately
                    const itemHtml = createBatchItemHtml(itemData);
                    batchResultsDiv.insertAdjacentHTML('beforeend', itemHtml);
                    
                    // Update summary
                    document.getElementById('summaryPassed').textContent = passedCount;
                    document.getElementById('summaryFailed').textContent = failedCount;
                    document.getElementById('summaryErrors').textContent = errorCount;
                    
                    // Update progress
                    const percent = ((i + 1) / total * 100).toFixed(0);
                    progressFill.style.width = percent + '%';
                    progressText.textContent = `${i + 1}/${total}`;
                    
                    // Scroll to bottom to show new result
                    batchResultsDiv.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                
            } catch (err) {
                repoList.innerHTML = `<p style="text-align: center; color: #f44336; padding: 20px;">${err.message}</p>`;
            } finally {
                // Restore repo list
                displayRepoList(approvedRepos);
                testSelectedBtn.disabled = false;
                selectAllBtn.disabled = false;
            }
        }
        
        function createBatchItemHtml(item) {
            let className = 'error';
            let icon = '[ERR]';
            
            if (item.error) {
                className = 'error';
                icon = '[ERR]';
            } else if (item.passed) {
                className = 'passed';
                icon = '[OK]';
            } else {
                className = 'failed';
                icon = '[FAIL]';
            }
            
            // Build details section
            let detailsHtml = '';
            if (!item.error) {
                detailsHtml = '<div class="batch-details">';
                
                // Passed checks
                if (item.passed_checks?.length > 0) {
                    detailsHtml += '<div style="margin-bottom: 6px;"><strong style="color: #4caf50;">✓ Passed:</strong><ul>';
                    item.passed_checks.forEach(check => {
                        detailsHtml += `<li>${check.name}: ${check.message}</li>`;
                    });
                    detailsHtml += '</ul></div>';
                }
                
                // Warnings
                if (item.warnings?.length > 0) {
                    detailsHtml += '<div style="margin-bottom: 6px;"><strong style="color: #ff9800;">⚠ Warnings:</strong><ul>';
                    item.warnings.forEach(check => {
                        detailsHtml += `<li>${check.name}: ${check.message}</li>`;
                    });
                    detailsHtml += '</ul></div>';
                }
                
                // Failed checks
                if (item.failed_checks?.length > 0) {
                    detailsHtml += '<div style="margin-bottom: 6px;"><strong style="color: #f44336;">✗ Failed:</strong><ul>';
                    item.failed_checks.forEach(check => {
                        detailsHtml += `<li>${check.name}: ${check.message}</li>`;
                    });
                    detailsHtml += '</ul></div>';
                }
                
                detailsHtml += '</div>';
            }
            
            return `
                <div class="batch-item ${className}">
                    <div>
                        <div class="batch-header">
                            <div class="batch-name">
                                <span style="font-size: 1em; margin-right: 8px; font-weight: bold;">${icon}</span>
                                <a href="${item.url}" target="_blank" style="color: #e0e0e0; text-decoration: none;">
                                    ${item.name}
                                </a>
                            </div>
                            <div class="batch-stats">
                                ${item.error ? 
                                    `<span style="color: #ff9800;">${item.error}</span>` :
                                    `
                                    <span>Stars: ${item.stars || 0}</span>
                                    <span>${item.language || 'N/A'}</span>
                                    ${item.passed_count > 0 ? `<span style="color: #4caf50;">Passed: ${item.passed_count}</span>` : ''}
                                    ${item.warning_count > 0 ? `<span style="color: #ff9800;">Warnings: ${item.warning_count}</span>` : ''}
                                    ${item.failed_count > 0 ? `<span style="color: #f44336;">Failed: ${item.failed_count}</span>` : ''}
                                    <span class="batch-score" style="color: ${item.score >= 75 ? '#4caf50' : '#f44336'};">
                                        ${item.score.toFixed(0)}
                                    </span>
                                    `
                                }
                            </div>
                        </div>
                        ${detailsHtml}
                    </div>
                </div>
            `;
        }
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const repoUrl = document.getElementById('repoUrl').value.trim();
            
            // Reset
            error.style.display = 'none';
            result.style.display = 'none';
            loading.style.display = 'block';
            verifyBtn.disabled = true;
            
            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        repo_url: repoUrl,
                        settings: settings
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to verify repository');
                }
                
                displayResult(data);
                
            } catch (err) {
                error.textContent = err.message;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                verifyBtn.disabled = false;
            }
        });
        
        function displayResult(data) {
            const repo = data.repository;
            
            // Header
            const header = document.getElementById('resultHeader');
            header.className = 'result-header ' + (data.passed ? 'passed' : 'failed');
            
            const repoNameEl = document.getElementById('repoName');
            repoNameEl.innerHTML = `<a href="${repo.url}" target="_blank" style="color: inherit; text-decoration: none;">${repo.name}</a>`;
            document.getElementById('score').textContent = `${data.score.toFixed(0)}/100`;
            document.getElementById('summary').textContent = data.passed ? 'PASSED' : 'FAILED';
            
            // Repo info
            const repoInfo = document.getElementById('repoInfo');
            repoInfo.innerHTML = `
                <div class="repo-info-item">
                    <label>Stars</label>
                    <span>${repo.stars}</span>
                </div>
                <div class="repo-info-item">
                    <label>Language</label>
                    <span>${repo.language || 'Unknown'}</span>
                </div>
                <div class="repo-info-item">
                    <label>License</label>
                    <span>${repo.license || 'None'}</span>
                </div>
            `;
            
            // Checks
            const checks = document.getElementById('checks');
            const passedChecks = data.passed_checks || [];
            const failedChecks = data.failed_checks || [];
            const warnings = data.warnings || [];
            
            let html = '';
            
            // Passed checks first (show what's good)
            if (passedChecks.length > 0) {
                html += '<h3 style="margin-bottom: 15px; color: #4caf50;">✓ Passed Checks</h3>';
                passedChecks.forEach(check => {
                    html += `
                        <div class="check-item passed">
                            <div class="check-icon">[✓]</div>
                            <div class="check-name">${check.name}</div>
                            <div class="check-message">${check.message}</div>
                        </div>
                    `;
                });
            }
            
            // Then warnings
            if (warnings.length > 0) {
                html += '<h3 style="margin: 20px 0 15px; color: #ff9800;">⚠ Warnings</h3>';
                warnings.forEach(check => {
                    html += `
                        <div class="check-item warning">
                            <div class="check-icon">[!]</div>
                            <div class="check-name">${check.name}</div>
                            <div class="check-message">${check.message}</div>
                        </div>
                    `;
                });
            }
            
            // Finally failed checks (what's missing)
            if (failedChecks.length > 0) {
                html += '<h3 style="margin: 20px 0 15px; color: #f44336;">✗ Failed Checks</h3>';
                failedChecks.forEach(check => {
                    html += `
                        <div class="check-item failed">
                            <div class="check-icon">[X]</div>
                            <div class="check-name">${check.name}</div>
                            <div class="check-message">${check.message}</div>
                        </div>
                    `;
                });
            }
            
            if (passedChecks.length === 0 && failedChecks.length === 0 && warnings.length === 0) {
                html = '<div style="text-align: center; padding: 20px; color: #888;"><h3>No check data available</h3></div>';
            }
            
            checks.innerHTML = html;
            result.style.display = 'block';
        }
        
        // Search form
        const searchForm = document.getElementById('searchForm');
        const searchLoading = document.getElementById('searchLoading');
        const searchError = document.getElementById('searchError');
        const searchResults = document.getElementById('searchResults');
        const searchBtn = document.getElementById('searchBtn');
        
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const query = document.getElementById('searchQuery').value.trim();
            const language = document.getElementById('searchLanguage').value;
            const minStars = settings.minStars;
            const minContributors = settings.minContributors;
            const maxResults = parseInt(document.getElementById('searchMaxResults').value) || 10;
            const repoAge = document.getElementById('searchRepoAge').value;
            
            if (!query && !language) {
                searchError.textContent = 'Please enter keywords or select a language';
                searchError.style.display = 'block';
                return;
            }
            
            // Reset
            searchError.style.display = 'none';
            searchResults.style.display = 'none';
            searchLoading.style.display = 'block';
            searchBtn.disabled = true;
            verifyBtn.disabled = true;
            
            try {
                // Build topics from query
                const topics = query ? query.split(/[,\s]+/).filter(t => t.length > 0) : [];
                
                // First get the list of repos to search
                searchLoading.innerHTML = '<div class="spinner"></div><p>Finding repositories...</p>';
                
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        language: language || null,
                        topics: topics,
                        min_stars: minStars,
                        min_contributors: minContributors,
                        max_results: maxResults,
                        repo_age_months: repoAge ? parseInt(repoAge) : null,
                        verify: false, // Don't verify yet, we'll do it one by one
                        settings: settings
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Search failed');
                }
                
                const repos = data.results;
                
                if (repos.length === 0) {
                    searchLoading.style.display = 'none';
                    searchError.textContent = 'No repositories found matching your criteria';
                    searchError.style.display = 'block';
                    return;
                }
                
                // Now verify them one by one with progress
                await verifySearchResults(repos);
                
            } catch (err) {
                searchError.textContent = err.message;
                searchError.style.display = 'block';
                searchLoading.style.display = 'none';
            } finally {
                searchBtn.disabled = false;
                verifyBtn.disabled = false;
            }
        });
        
        async function verifySearchResults(repos) {
            const total = repos.length;
            
            // Show progress UI
            searchLoading.innerHTML = `
                <div style="text-align: center;">
                    <p>Verifying ${total} repositories...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="searchProgressFill" style="width: 0%"></div>
                        <div class="progress-text" id="searchProgressText">0/${total}</div>
                    </div>
                </div>
            `;
            
            // Show results container and list all repos immediately
            searchResults.style.display = 'block';
            const resultsList = document.getElementById('searchResultsList');
            resultsList.innerHTML = '';
            
            // Create all items with pending status
            repos.forEach((repo, index) => {
                const itemHtml = createPendingSearchItem(repo, index);
                resultsList.insertAdjacentHTML('beforeend', itemHtml);
            });
            
            const progressFill = document.getElementById('searchProgressFill');
            const progressText = document.getElementById('searchProgressText');
            
            let passedCount = 0;
            let failedCount = 0;
            
            // Verify each repo and update its status
            for (let i = 0; i < repos.length; i++) {
                const repo = repos[i];
                const itemId = `search-item-${i}`;
                
                // Mark as verifying
                updateSearchItemStatus(itemId, 'verifying');
                
                try {
                    // Verify this repo
                    const verifyResponse = await fetch('/api/verify-single', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            repo_url: repo.url,
                            settings: settings
                        })
                    });
                    
                    const verifyData = await verifyResponse.json();
                    
                    if (verifyData.passed) {
                        passedCount++;
                        updateSearchItemStatus(itemId, 'passed', {
                            score: verifyData.score,
                            stars: verifyData.stars,
                            language: verifyData.language,
                            license: repo.license,
                            passed_count: verifyData.passed_count || 0,
                            failed_count: verifyData.failed_count || 0,
                            warning_count: verifyData.warning_count || 0,
                            passed_checks: verifyData.passed_checks || [],
                            failed_checks: verifyData.failed_checks || [],
                            warnings: verifyData.warnings || []
                        });
                    } else {
                        failedCount++;
                        updateSearchItemStatus(itemId, 'failed', {
                            score: verifyData.score || 0,
                            stars: verifyData.stars,
                            language: verifyData.language,
                            license: repo.license,
                            passed_count: verifyData.passed_count || 0,
                            failed_count: verifyData.failed_count || 0,
                            warning_count: verifyData.warning_count || 0,
                            passed_checks: verifyData.passed_checks || [],
                            failed_checks: verifyData.failed_checks || [],
                            warnings: verifyData.warnings || []
                        });
                    }
                } catch (err) {
                    failedCount++;
                    updateSearchItemStatus(itemId, 'error', { error: err.message });
                }
                
                // Update progress
                const percent = ((i + 1) / total * 100).toFixed(0);
                progressFill.style.width = percent + '%';
                progressText.textContent = `${i + 1}/${total} (${passedCount} passed)`;
            }
            
            // Hide loading
            searchLoading.style.display = 'none';
        }
        
        function createPendingSearchItem(repo, index) {
            return `
                <div id="search-item-${index}" class="batch-item" style="background: #2a2a2a;">
                    <div class="batch-header">
                        <div class="batch-name">
                            <span style="margin-right: 8px; color: #888;" class="item-status">[PENDING]</span>
                            <a href="${repo.url}" target="_blank" style="color: #e0e0e0; text-decoration: none;" class="item-link">
                                ${repo.name}
                            </a>
                        </div>
                        <div class="batch-stats">
                            <span style="color: #888;">Waiting...</span>
                        </div>
                    </div>
                    <div class="item-details" style="display: none;"></div>
                </div>
            `;
        }
        
        function updateSearchItemStatus(itemId, status, data = {}) {
            const item = document.getElementById(itemId);
            if (!item) return;
            
            const header = item.querySelector('.batch-header');
            const statusSpan = item.querySelector('.item-status');
            const statsDiv = header.querySelector('.batch-stats');
            const detailsDiv = item.querySelector('.item-details');
            
            if (status === 'verifying') {
                item.style.background = '#2a2a2a';
                statusSpan.style.color = '#ff9800';
                statusSpan.textContent = '[CHECKING...]';
                statsDiv.innerHTML = '<span style="color: #ff9800;">Verifying...</span>';
            } else if (status === 'passed') {
                item.style.background = '#1e2e1e';
                item.style.borderLeft = '4px solid #4caf50';
                statusSpan.style.color = '#4caf50';
                statusSpan.textContent = '[PASSED]';
                statsDiv.innerHTML = `
                    <span>Stars: ${data.stars || 0}</span>
                    <span>${data.language || 'N/A'}</span>
                    ${data.passed_count > 0 ? `<span style="color: #4caf50;">Passed: ${data.passed_count}</span>` : ''}
                    ${data.warning_count > 0 ? `<span style="color: #ff9800;">Warnings: ${data.warning_count}</span>` : ''}
                    ${data.failed_count > 0 ? `<span style="color: #f44336;">Failed: ${data.failed_count}</span>` : ''}
                    <span class="batch-score" style="color: #4caf50; font-weight: bold; font-size: 1.2em;">${data.score.toFixed(0)}</span>
                `;
                
                // Show details
                detailsDiv.style.display = 'block';
                detailsDiv.innerHTML = createDetailsHtml(data);
            } else if (status === 'failed') {
                item.style.background = '#2e1e1e';
                item.style.borderLeft = '4px solid #f44336';
                statusSpan.style.color = '#f44336';
                statusSpan.textContent = '[FAILED]';
                statsDiv.innerHTML = `
                    <span>Stars: ${data.stars || 0}</span>
                    <span>${data.language || 'N/A'}</span>
                    ${data.passed_count > 0 ? `<span style="color: #4caf50;">Passed: ${data.passed_count}</span>` : ''}
                    ${data.warning_count > 0 ? `<span style="color: #ff9800;">Warnings: ${data.warning_count}</span>` : ''}
                    ${data.failed_count > 0 ? `<span style="color: #f44336;">Failed: ${data.failed_count}</span>` : ''}
                    <span class="batch-score" style="color: #f44336; font-weight: bold; font-size: 1.2em;">${data.score.toFixed(0)}</span>
                `;
                
                // Show details
                detailsDiv.style.display = 'block';
                detailsDiv.innerHTML = createDetailsHtml(data);
            } else if (status === 'error') {
                item.style.background = '#2e2a1e';
                item.style.borderLeft = '4px solid #ff9800';
                statusSpan.style.color = '#ff9800';
                statusSpan.textContent = '[ERROR]';
                statsDiv.innerHTML = `<span style="color: #ff9800;">${data.error || 'Verification failed'}</span>`;
            }
        }
        
        function createDetailsHtml(data) {
            let html = '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #3a3a3a; font-size: 0.85em;">';
            
            // Passed checks
            if (data.passed_checks && data.passed_checks.length > 0) {
                html += '<div style="margin-bottom: 8px;"><strong style="color: #4caf50;">✓ Passed:</strong><ul style="margin: 4px 0; padding-left: 20px;">';
                data.passed_checks.forEach(check => {
                    html += `<li style="color: #b0b0b0; margin: 2px 0;">${check.name}: ${check.message}</li>`;
                });
                html += '</ul></div>';
            }
            
            // Warnings
            if (data.warnings && data.warnings.length > 0) {
                html += '<div style="margin-bottom: 8px;"><strong style="color: #ff9800;">⚠ Warnings:</strong><ul style="margin: 4px 0; padding-left: 20px;">';
                data.warnings.forEach(check => {
                    html += `<li style="color: #b0b0b0; margin: 2px 0;">${check.name}: ${check.message}</li>`;
                });
                html += '</ul></div>';
            }
            
            // Failed checks
            if (data.failed_checks && data.failed_checks.length > 0) {
                html += '<div style="margin-bottom: 8px;"><strong style="color: #f44336;">✗ Failed:</strong><ul style="margin: 4px 0; padding-left: 20px;">';
                data.failed_checks.forEach(check => {
                    html += `<li style="color: #b0b0b0; margin: 2px 0;">${check.name}: ${check.message}</li>`;
                });
                html += '</ul></div>';
            }
            
            html += '</div>';
            return html;
        }
        
    </script>
</body>
</html>
